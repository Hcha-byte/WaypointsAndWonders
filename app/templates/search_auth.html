<!-- templates/search_auth.html -->
{% extends "base.html" %}

{% block content %}
<h2>Reindex All Posts</h2>

<form method="post" action="{{ url_for('search.index_all') }}">
	<input type="hidden" name="auth" value="{{ auth }}">
	<button type="submit" class="button">Confirm Reindex</button>
</form>

<div style="margin-top: 1rem;">
	<progress id="progress-bar" value="0" max="100" style="width: 100%; height: 20px;"></progress>
	<div id="progress-message" style="margin-top: 0.5rem;"></div>
</div>


<script>
	async function checkProgress() {
		const res = await fetch("{{ url_for('search.reindex_all_progress') }}");
		const data = await res.json();

		const progressBar = document.getElementById("progress-bar");
		const statusDiv = document.getElementById("progress-message");

		if (data.status === "not_started") {
			statusDiv.innerText = "Waiting to start...";
			progressBar.value = 0;
		} else if (data.status === "in_progress") {
			statusDiv.innerText = `Reindexing in progress... (${data.progress}%)`;
			progressBar.value = data.progress;
		} else if (data.status === "finished") {
			statusDiv.innerText = "✅ Reindexing complete!";
			progressBar.value = 100;
			clearInterval(progressInterval);
		} else if (data.status === "failed") {
			statusDiv.innerText = "❌ Reindexing failed: " + data.error;
			progressBar.value = 0;
			clearInterval(progressInterval);
		} else {
			statusDiv.innerText = "Unknown status: " + data.message;
			clearInterval(progressInterval);
		}
	}

	const progressInterval = setInterval(checkProgress, 3000);
	checkProgress();
</script>


{% endblock %}
